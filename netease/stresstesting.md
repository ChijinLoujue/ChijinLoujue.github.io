# 压力测试(2020.10.12)
## 介入时机
**准备期（中期评审后）**
方案制定、流程验证
**渠道测试**
目标：小规模下的稳定性      
玩家规模 ：小规模(w以内，计划)       稳定性要求：运行时长较短       测试内容：核心玩法、登录
**上线测试**
目标：大规模下的稳定性      
玩家规模 ：大规模（承载极限）      稳定性要求： 持续时间较长或永久/服务器资源的持续性      测试内容：活动、充值
==其实不管上线测试还是渠道测试都需要关注到所有的模块==
**运营测试**
目标：实际规模下的稳定性      
玩家规模 ：运营当前规模       稳定性要求：更新和迭代时的稳定性/新增服务器性能保障       测试内容：迭代内容
==hotfix等一般不作为我们压测的工作，我们只负责压力相关的问题，服务器稳定性及容灾是我们的范畴==
## 压测的目的及意义
1.服务器在规模和性能上存在客观的、物理上的负载有限性和不稳定性（带宽、CPU、内存、硬盘）
2.用户规模存在长期和短期的剧增可能
3.服务器负载和用户规模正相关
4.服务器超负荷时会引发物理或执行逻辑上的各种问题（延迟、崩溃、运行错误）
5.产品出现问题会降低用户体验、破坏产品口碑、影响产品收入

## 压测的手段及方法
### 协议压测机器人
模拟客户端发送通信数据
编写测试用例

### 压测环境
**压测机器人集群**
QA/SA搭建压测机配置环境
**压测服务器集群**
程序与SA搭建

### 压测平台
nomad管理-打点数据采集-自动报警-压测报告

#### Loadlab平台
**功能**
压测资源管理
压测用例配置管理
机器人打点数据统计
压测报告
服务器性能监控报告

## 常用测试工具
协议测试工具
客户端/服务端日志
protocol协议录制工具
**确保机器人覆盖必要协议**
不漏协议
模拟客户端

## 标准流程
启动阶段-规划阶段-执行阶段-监控阶段-收尾阶段

### 时间消耗
准备期：1周      渠道期：1.5月    付费期：1月    上线期：1月

### 压测目标
压力上线 服务器配比  容灾建议

### 项目信息收集
游戏信息  服务器信息 责任信息
==服务器（包括微服务）架构、引擎、测试国家、放号策略等==

### 压测准备
**调研**
游戏熟悉，模块用例梳理，机器人框架，风险评估，制定计划，权限申请
**会议沟通**
**权限申请**
**计划制定**（用例，优先级，责任人，进度排期，结果信息）
**用例设计**
压力点
**用例编写**
压测框架
压测机器人、压测环境、压测平台

### 压测执行
压测指标
性能监测

### 监控阶段
定位原因
优先级确认
责任人确认
即时反馈
事故定级

### 进度跟进
风险管理
时间管理
及时沟通
异常处理与紧急预案

### 收尾
压测报告（问题与修复）
交接与维护

## 配合与沟通
做好调研
会议讨论
计划合理
即时反馈

## 关键词
**PCU** 同时在线人数
**DAU**日活
**QPS**秒查询率
**TPS**秒事务量

# 压力测试(2020.10.13)
## Loadlab平台
**功能**
用例管理
脚本管理
资源调配
任务管理
数据可视
打点耗时
报告总结
**管理 整合 监控 汇总**

## 平台架构
server  模块间通信
spy     监控
slave   容器内执行
master  控制容器交互
kafka   拿数据    Kafka是一种高吞吐量的分布式发布订阅消息系统

mamager  上传代码暂存
web-frontend  前端
redis   性能数据存储
report  报告

## 代码生命周期
选择脚本 - pull打包  上传volmg
执行job - 拉取镜像-拉slave代码
拉用户脚本
重build
build image
push到dockerhub
在容器中run
**多方式上传 项目共享 提升效率**

## 压测任务生命周期
流程主要由server控制执行   job:jenkins的pipeline？
资源管理：**Nomad** 集群管理器和调度器   
slave（奴隶？）管理 ：master（主人？） 用master来管理容器的交互
数据传输/启动bot：slave
启动job 检查预约 job建立 资源判断 分配资源 执行 终止/结束 记录数据 回收资源

## 压测数据流转周期
### Monitor
spy爬取
缓存至**redis**      内存高速缓存数据库
**Mongo**做数据持久化     基于分布式文件存储的数据库
spy作数据接口开放给专家系统
### kafka
由容器logger发起至kafka broker
server从数据读取后整合展示
压测报告作为单独的模块，前端 专家系统

## 压测的准备
压测工具：机器人protobot
压测对象：目标游戏服务器
压测权限：wordflow,git
docker

## 项目配置
基本信息
环境镜像:
在本机进行脚本运行时使用了基于docker的linux系统环境，因此，为了保证脚本环境的一致性
loadlab有添加镜像的功能，在镜像栏配置指令，可以获得环境镜像
环境变量：
环境变量是在平台UI上设置的变量可以直接在脚本中使用，方便修改数据的时候不需要重新修改脚本
工作目录：
是环境镜像系统的linux目录,脚本放置的位置

数据采集：
  服务器配置 进程组配置
PCU CPU 内存 时间  网域
## 用例配置
基础  脚本 运行 启动  看着有点像jenkins的job
## 执行
压测进程数 数据统计  服务器性能 容器调试 专家系统
## 测试总结
环境 流程 总结 问题记录

## 常见问题
进程问题
网络问题

## 游戏通信方式
RPC 

# 压力测试(2020.10.14)

## protobot

模仿客户端网络层协议向服务器发送数据

### 项目接入

安装库

下载机器人模板

把引擎文件放入到模板中

定制接口层代码

专业和执行用例



## 协议录制工具Protocol

1， 录制游戏协议

2， 游戏通信协议转压测代码

[Protocol](http://protocol.fit.nie.netease.com/)

### 本地调试

框架配置

日志

机器人配置



## 评估指标

性能数据 CPU 内存 流量

用例执行成功率

服务器接口响应耗时

服务器处理速率 TPS



执行成功率：
机器人打点上报接口 bot.mark

耗时

耗时上报接口 bot.record_cost



## 登录压测示例

了解RPC通信，使用协议录制工具，生产压测代码

本地调试：

日志连接配置 机器人启动指令  IDE断点调试

批量压测：

loadlab平台

平台项目配置

用例配置执行



数据收集：

成功率

响应时间 QPS TPS



protobot用例组织进阶

用例复用

并发执行:同步模块和异步模块

不定期消息：异步模块/向protobot注册服务端回调




# 压力测试(2020.10.19)
压测对象：服务器
问题：宕机  故障  拒绝服务  极高延迟

## 流程
脚本编写/调试
确定qps
启动压测
观测指标
验证功能
问题跟进

通用指标：CPU过高，负载不均  内存爆满
带宽  IO过高  磁盘写满
进程指标  错误日志  内存
数据库指标：操作数  比较关键，读写等操作过于频繁
连接数  
慢日志   耗时越来越长
分片负载  分片负载区别太大 ，浪费资源  短板效应
机器人指标：打点 耗时 日志

## 工具链：
### Monitor 
大而全   
服务器/进程/数据库/容器
多视图
多维度数据

机器级别
进程级别  ：支持定制
数据库级别：主从 分片  关联

### loghub
日志收集 检索
慢日志统计 方便查找，集群聚合  

### symphony2 
容器管理平台（docker&k8s)
信息全面、可视性强
集群
和monitor容器互补

### redis管理
DBSaas  jetis将弃用

### 在线人数平台
机器人校验 权限敏感

## 问题处理
简单问题：
负载过高
流量过大
慢日志

复杂问题：
内存泄漏
负载不均
延迟生效
功能异常

查：
明确压测脚本流程
明确压力点
明确调用链
提供机器人数据/服务器数据
协助程序复现

服务端架构
通信部分
进程逻辑部分
数据库部分
微服务部分


# 压力测试(2020.10.20)
压测用例
压什么  怎么压  标准是什么
用例概览
**MMO** 
登录 新手副本 主线/低等级剧情 副本 世界聊天 帮派社团 定时活动 世界boss 好友 抽奖
**吃鸡** 登录 新手流程 匹配战斗 世界聊天 定时活动 抽奖
**卡牌** 登录 世界聊天 匹配战斗 好友 抽奖

### 特点
人多的操作 （并发高的） 登录 聊天匹配战斗
有列表的操作 （列表限长）商城 好友 排行榜
广播操作（跑马灯 全服抽奖）
金钱相关 充值抽奖
存盘 离线消息
容灾和稳定性

### 登录功能示例
**是什么？**
登录流程，什么才算登录完成？
建立tcp连接 -> 交换密钥 -> 创建entity (通信实体) -> 拉取玩家信息
怎么压
新号登录（排队）
顶号登录
老帐号登录
重复上下线   功能性问题检测（相关数据的清除） 内存泄漏？

创建新号的数据库读写


### 写用例
录制协议
关键点打点

打耗时
完成次数

### 评判指标
压测用例每个有意义阶段的额耗时
QPS(找到没有性能问题的分界点和经验值)
成功率（不是服务器逻辑验证）
有规律的打点耗时数据



